"use strict";angular.module("descentCampaignTrackerApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/saveAndLoad",{templateUrl:"views/saveandload.html",controller:"SaveandloadCtrl",controllerAs:"saveAndLoad"}).otherwise({redirectTo:"/"})}]).config(["localStorageServiceProvider",function(a){a.setPrefix("desCT")}]),angular.module("descentCampaignTrackerApp").controller("MainCtrl",["$scope","localStorageService","desCamaignCons","desModel","desOverlord","desLieutenant","desMonster","desHero","desLocation","desCampaign",function(a,b,c,d,e,f,g,h,i,j){function k(){s.addInputs.plotUpgrade=r(s.addInputs.plotUpgrade,e.addPlotUpgrade.bind(void 0,s.model.overlord),e.newUpgrade)}function l(){s.addInputs.commonUpgrade=r(s.addInputs.commonUpgrade,e.addCommonUpgrade.bind(void 0,s.model.overlord),e.newUpgrade)}function m(){s.addInputs.lieutenant=r(s.addInputs.lieutenant,f.addLieutenant.bind(void 0,s.model.lieutenants),f.newLieutenant)}function n(){s.addInputs.hero=r(s.addInputs.hero,h.addHero.bind(void 0,s.model.heroParty),h.newHero)}function o(){s.addInputs.city=r(s.addInputs.city,i.addCity.bind(void 0,s.model.locations),i.newCity)}function p(){s.addInputs.dungeon=r(s.addInputs.dungeon,i.addDungeon.bind(void 0,s.model.locations),i.newDungeon)}function q(){s.addInputs.island=r(s.addInputs.island,i.addIsland.bind(void 0,s.model.locations),i.newIsland)}function r(a,b,c){return a&&angular.isDefined(a.name)&&angular.isString(a.name)&&a.name.length>0?(b(a),c()):a}var s=this;s.cons={campaign:c},s.model=d.getModel(),s.addInputs={plotUpgrade:e.newUpgrade(),commonUpgrade:e.newUpgrade(),lieutenant:f.newLieutenant(),hero:h.newHero(),city:i.newCity(),island:i.newIsland(),dungeon:i.newDungeon()},s.api={addPlotUpgrade:k,removePlotUpgrade:e.removePlotUpgrade.bind(void 0,s.model.overlord),addCommonUpgrade:l,removeCommonUpgrade:e.removeCommonUpgrade.bind(void 0,s.model.overlord),addLieutenant:m,removeLieutenant:f.removeLieutenant.bind(void 0,s.model.lieutenants),modifyMonsterLevel:g.modifyMonsterLevel,addOverlordConquestTockens:e.addOverlordConquestTockens.bind(void 0,s.model.overlord),addOverlordSpentTockens:e.addOverlordSpentTockens.bind(void 0,s.model.overlord),overlordAviableConquestTockens:e.overlordAviableConquestTockens.bind(void 0,s.model.overlord),increaseCurrentTreachery:e.increaseCurrentTreachery,increaseMaxTreachery:e.increaseMaxTreachery,addHero:n,removeHero:h.removeHero.bind(void 0,s.model.heroParty),addHeroesConquestTockens:h.addHeroesConquestTockens.bind(void 0,s.model.heroParty),addSpentHeroXP:h.addSpentHeroXP.bind(void 0,s.model.heroParty),xpAviableHero:h.xpAviableHero.bind(void 0,s.model.heroParty),addCity:o,removeCity:i.removeCity.bind(void 0,s.model.locations),addCitySiegeTocken:i.addCitySiegeTocken,toggleCityRazed:i.toggleCityRazed,addDungeon:p,removeDungeon:i.removeDungeon.bind(void 0,s.model.locations),addIsland:q,removeIsland:i.removeIsland.bind(void 0,s.model.locations),toggleAdvLocVisited:i.toggleAdvLocVisited,toggleAdvLocConquered:i.toggleAdvLocConquered,toggleAdvLocFailed:i.toggleAdvLocFailed,divineFavor:j.divineFavor.bind(void 0,s.model.overlord,s.model.heroParty),totalCampaignTockens:j.totalCampaignTockens.bind(void 0,s.model.overlord,s.model.heroParty),campaignLevel:j.campaignLevel.bind(void 0,s.model.overlord,s.model.heroParty)},a.model=s.model,a.$watch("model",function(){d.saveModel()},!0)}]),angular.module("descentCampaignTrackerApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("descentCampaignTrackerApp").factory("desModel",["$log","localStorageService","desCamaignCons","desCore","desOverlord","desLieutenant","desMonster","desHero","desLocation",function(a,b,c,d,e,f,g,h,i){function j(){return p}function k(){return b.get(c.LOCAL_STORAGE_NAME)}function l(){b.set(c.LOCAL_STORAGE_NAME,p)}function m(){return angular.toJson(p,2)}function n(b){var c,d={success:!1,text:null},e=o();try{a.debug("Convirtiendo entrada "+b),c=angular.fromJson(b)}catch(f){a.error("Error convirtiendo entrada en JSON: "+f),d.success=!1,d.text="Conversion error: "+f.message}return angular.isObject(c)?(angular.extend(e,c),p=e,d.success=!0,d.text="CampaÃ±a importada correctamente."):angular.isUndefined(d.text)&&(d.text="La entrada no es un JSON"),a.debug(d),d}function o(){return{overlord:e.newOverlord(),lieutenants:f.newLieutenants(),monsterLevels:g.newMonsterLevels(),heroParty:h.newHeroParty(),locations:i.newLocations()}}var p=k()||o();return{getModel:j,loadModel:k,saveModel:l,toJSON:m,fromJSON:n}}]),angular.module("descentCampaignTrackerApp").filter("rgtDesMonsterLevel",function(){return function(a){var b=a.level||1,c="Cobre";switch(b){case 2:c="Plata";break;case 3:c="Oro";break;case 4:c="Diamante";break;default:c="Cobre"}return c}}),angular.module("descentCampaignTrackerApp").factory("desTreachery",[function(){function a(){return{current:0,max:0}}function b(a,b){var c=a.current||0,d=a.max||0,e=c+(b||0);d>=e&&e>=0&&(a.current=e)}function c(a,b){var c=a.current||0,d=(a.max||0)+(b||0);d>=0&&d>=c&&(a.max=d)}return{newTreacheryCounter:a,increaseCurrentTreachery:b,increaseMaxTreachery:c}}]),angular.module("descentCampaignTrackerApp").constant("desCamaignCons",{LOCAL_STORAGE_NAME:"descentCampaign",MAX_HERO_PARTY_SIZE:4,DIVINE_FACTOR_DIFFERENCE:25,SILVER_THRESHOLD:200,GOLD_THRESHOLD:400,FINAL_BATTLE_THRESHOLD:600}),angular.module("descentCampaignTrackerApp").factory("desCore",["$filter",function(a){function b(b,c){return b=b||[],b.push(c),a("orderBy")(b,"name",!1)}function c(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}return a()+a(!0)+a(!0)+a()}return{newUid:c,orderAndAddNamedItemToArray:b}}]),angular.module("descentCampaignTrackerApp").factory("desHero",["desCore",function(a){function b(){return{location:"",homePort:"",rumor:{name:"",location:""},heroes:[],conquestTockens:0}}function c(){return{name:"",xpSpent:null}}function d(b,c){c.xpSpent=Math.max(0,c.xpSpent||0),b.heroes=a.orderAndAddNamedItemToArray(b.heroes,c)}function e(a,b){a.heroes.splice(b,1)}function f(a,b,c){var d=(b.xpSpent||0)+(c||0),e=a.conquestTockens||0;d>=0&&e>=d&&(b.xpSpent=d)}function g(a,b){return(a.conquestTockens||0)-(b.xpSpent||0)}function h(a,b){var c=(a.conquestTockens||0)+(b||0);c>=0&&(a.conquestTockens=c)}return{newHeroParty:b,newHero:c,addHero:d,removeHero:e,addSpentHeroXP:f,xpAviableHero:g,addHeroesConquestTockens:h}}]),angular.module("descentCampaignTrackerApp").factory("desLocation",["desCore",function(a){function b(){return{cities:[],dungeons:[],islands:[]}}function c(a){return{name:"",type:a}}function d(){var a=angular.extend({},c("C"));return a.siege=0,a.vault="",a.razed=!1,a}function e(){var a=angular.extend({},c("A"));return a.visited=!1,a.conquered=!1,a.failed=!1,a}function f(){var a=e();return a.levels=["",""],a}function g(){var a=e();return a.levels=["","",""],a}function h(b,c){c.siege=Math.max(0,c.siege||0),b.cities=a.orderAndAddNamedItemToArray(b.cities,c)}function i(a,b){a.cities.splice(b,1)}function j(a,b){var c=(a.siege||0)+(b||0);c>=0&&(a.siege=c)}function k(a){a.razed=!a.razed}function l(b,c){b.dungeons=a.orderAndAddNamedItemToArray(b.dungeons,c)}function m(a,b){a.dungeons.splice(b,1)}function n(b,c){b.islands=a.orderAndAddNamedItemToArray(b.islands,c)}function o(a,b){a.islands.splice(b,1)}function p(a,b){a.conquered||a.failed||(a.visited=b)}function q(a,b){a.visited&&!a.failed&&(a.conquered=b)}function r(a,b){a.visited&&!a.conquered&&(a.failed=b)}return{newLocations:b,newCity:d,addCity:h,removeCity:i,addCitySiegeTocken:j,toggleCityRazed:k,newDungeon:g,addDungeon:l,removeDungeon:m,newIsland:f,addIsland:n,removeIsland:o,toggleAdvLocVisited:p,toggleAdvLocConquered:q,toggleAdvLocFailed:r}}]),angular.module("descentCampaignTrackerApp").factory("desOverlord",["desCore","desOverlordUpgrade","desTreachery",function(a,b,c){function d(){return{name:"",plot:"",plotUpgrades:[],commonUpgrades:[],conquestTockens:0,spentTockens:0,treachery:{traps:c.newTreacheryCounter(),events:c.newTreacheryCounter(),monsters:c.newTreacheryCounter()}}}function e(a,b){var c=(a.conquestTockens||0)+(b||0);c>=0&&(a.conquestTockens=c)}function f(a,b){var c=(a.spentTockens||0)+(b||0),d=a.conquestTockens||0;c>=0&&d>=c&&(a.spentTockens=c)}function g(a){return(a.conquestTockens||0)-(a.spentTockens||0)}return{newOverlord:d,newUpgrade:b.newUpgrade,addPlotUpgrade:b.addPlotUpgrade,removePlotUpgrade:b.removePlotUpgrade,addCommonUpgrade:b.addCommonUpgrade,removeCommonUpgrade:b.removeCommonUpgrade,addOverlordConquestTockens:e,addOverlordSpentTockens:f,overlordAviableConquestTockens:g,increaseCurrentTreachery:c.increaseCurrentTreachery,increaseMaxTreachery:c.increaseMaxTreachery}}]),angular.module("descentCampaignTrackerApp").factory("desLieutenant",["desCore",function(a){function b(){return{list:[]}}function c(){return{name:"",location:"",alive:!0}}function d(b,c){b.list=a.orderAndAddNamedItemToArray(b.list,c)}function e(a,b){a.list.splice(b,1)}return{newLieutenants:b,newLieutenant:c,addLieutenant:d,removeLieutenant:e}}]),angular.module("descentCampaignTrackerApp").factory("desMonster",[function(){function a(){return[{name:"Humanoides",level:1},{name:"Bestias",level:1},{name:"Arcanos",level:1}]}function b(a,b){var c=a.level||1,d=c+b;d>=1&&4>=d&&(a.level=d)}return{newMonsterLevels:a,modifyMonsterLevel:b}}]),angular.module("descentCampaignTrackerApp").factory("desOverlordUpgrade",["desCore",function(a){function b(){return{name:""}}function c(a,b){a.splice(b,1)}function d(b,c){b.plotUpgrades=a.orderAndAddNamedItemToArray(b.plotUpgrades,c)}function e(a,b){c(a.plotUpgrades,b)}function f(b,c){b.commonUpgrades=a.orderAndAddNamedItemToArray(b.commonUpgrades,c)}function g(a,b){c(a.commonUpgrades,b)}return{newUpgrade:b,addPlotUpgrade:d,removePlotUpgrade:e,addCommonUpgrade:f,removeCommonUpgrade:g}}]),angular.module("descentCampaignTrackerApp").factory("desCampaign",["desCamaignCons",function(a){function b(b,c){var d=b.conquestTockens||0,e=c.conquestTockens||0,f=Math.abs(d-e),g=1;d>e&&(g=-1);var h=Math.floor(f/a.DIVINE_FACTOR_DIFFERENCE)*g;return h}function c(a,b){var c=b.conquestTockens||0,d=a.conquestTockens||0;return c+d}function d(b,d){var e="Cobre",f=c(b,d);return f>=a.SILVER_THRESHOLD?e="Plata":f>=a.GOLD_THRESHOLD?e="Oro":f>=a.FINAL_BATTLE_THRESHOLD&&(e="Oro - Batalla final"),e}return{divineFavor:b,totalCampaignTockens:c,campaignLevel:d}}]),angular.module("descentCampaignTrackerApp").controller("SaveandloadCtrl",["desModel",function(a){function b(){e.model.output=a.toJSON()}function c(){e.model.importResult=a.fromJSON(e.model.input),e.model.showImportMessage=!0}function d(){e.model.output="toObsidianPortalWiki"}var e=this;e.model={output:"",input:"",showImportMessage:!1,importResult:{}},e.api={toJSON:b,fromJSON:c,toObsidianPortalWiki:d}}]);